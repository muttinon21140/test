<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LINE LIFF Registration</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
  <h1>ลงทะเบียนผู้ใช้</h1>

  <div id="formContainer" style="display:none;">
    <p>ชื่อ: <input id="firstName"></p>
    <p>นามสกุล: <input id="lastName"></p>
    <p>เพศ:
      <select id="gender">
        <option value="">เลือกเพศ</option>
        <option value="ชาย">ชาย</option>
        <option value="หญิง">หญิง</option>
      </select>
    </p>
    <p>เบอร์โทร: <input id="phone"></p>
    <p>ที่อยู่: <input id="address"></p>
    <button onclick="register()">ลงทะเบียน</button>
  </div>

  <div id="welcome" style="display:none;"></div>

  <script>
    const liffId = "2007981677-Z8m3omk4";
    const apiUrl = "https://script.google.com/macros/s/AKfycbx6byXWQeJBcHK89Ju47CqqGYlaU79PkS7joKP3OFE20WfZRqOdBES5umP_6pbUO15G/exec";
    let userProfile;

    async function main() {
      await liff.init({ liffId });

      if (!liff.isLoggedIn()) {
        // ใส่ redirectUri ป้องกันลูป
        liff.login({ redirectUri: window.location.href });
        return; // รอหลัง login กลับมา
      }

      userProfile = await liff.getProfile();

      try {
        const res = await fetch(`${apiUrl}?userId=${userProfile.userId}`);
        const data = await res.json();

        if (data.exists && data.data) {
          document.getElementById("welcome").style.display = "block";
          document.getElementById("welcome").innerText =
            `สวัสดี ${data.data[2]} ${data.data[3]}! คุณลงทะเบียนแล้ว`;
          document.getElementById("formContainer").style.display = "none";
        } else {
          document.getElementById("formContainer").style.display = "block";
          document.getElementById("welcome").style.display = "none";
        }
      } catch (err) {
        alert("❌ เกิดข้อผิดพลาดในการโหลดข้อมูล: " + err);
      }
    }

    async function register() {
      const userObj = {
        userId: userProfile.userId,
        displayName: userProfile.displayName,
        firstName: document.getElementById("firstName").value,
        lastName: document.getElementById("lastName").value,
        gender: document.getElementById("gender").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value
      };

      if (!userObj.firstName || !userObj.lastName || !userObj.gender || !userObj.phone || !userObj.address) {
        alert("กรุณากรอกข้อมูลให้ครบทุกช่อง");
        return;
      }

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          body: JSON.stringify(userObj),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();
        if (data.success) {
          alert("ลงทะเบียนเรียบร้อย!");
          location.reload();
        } else {
          alert("❌ เกิดข้อผิดพลาด: " + data.error);
        }
      } catch (err) {
        alert("❌ เกิดข้อผิดพลาด: " + err);
      }
    }

    main();
  </script>
</body>
</html>
