<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LIFF Registration</title>
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
<h1>ลงทะเบียนผู้ใช้</h1>

<div id="formContainer" style="display:none;">
  <p>ชื่อ: <input id="firstName"></p>
  <p>นามสกุล: <input id="lastName"></p>
  <p>เพศ: 
    <select id="gender">
      <option value="">เลือกเพศ</option>
      <option value="ชาย">ชาย</option>
      <option value="หญิง">หญิง</option>
    </select>
  </p>
  <p>เบอร์โทร: <input id="phone"></p>
  <p>ที่อยู่: <input id="address"></p>
  <button onclick="register()">ลงทะเบียน</button>
</div>

<div id="welcome" style="display:none;"></div>

<script>
const liffId = "2007981677-Z8m3omk4"; // ใส่ LIFF ID ของคุณ
const webAppUrl = "https://script.google.com/macros/s/AKfycbzxXCVJ6IMi8r_DeDPBOtu75bGTQYpVphgXlGE_thxvs2FTSI9mWDDUW-qs47ONdeGx/exec"; // URL จากขั้นตอน 3

let userProfile;

async function main() {
  await liff.init({ liffId });

  if (!liff.isLoggedIn()) liff.login();

  try {
    userProfile = await liff.getProfile();

    const res = await fetch(webAppUrl, {
      method: "POST",
      body: JSON.stringify({ userId: userProfile.userId }),
      headers: { "Content-Type": "application/json" }
    });

    const result = await res.json();
    console.log("Check user result:", result);

    if(result.error){
      alert("เกิดข้อผิดพลาด: " + result.error);
      document.getElementById("formContainer").style.display = "block";
    } else if(result.exists){
      document.getElementById("welcome").style.display = "block";
      document.getElementById("welcome").innerText = `สวัสดี ${userProfile.displayName}! คุณลงทะเบียนแล้ว`;
    } else {
      document.getElementById("formContainer").style.display = "block";
    }

  } catch(err){
    console.error(err);
    alert("เกิดข้อผิดพลาดในการเชื่อมต่อ Web App: " + err.message);
    document.getElementById("formContainer").style.display = "block";
  }
}

async function register() {
  const userObj = {
    userId: userProfile.userId,
    displayName: userProfile.displayName,
    firstName: document.getElementById("firstName").value,
    lastName: document.getElementById("lastName").value,
    gender: document.getElementById("gender").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value
  };

  if(!userObj.firstName || !userObj.lastName || !userObj.gender || !userObj.phone || !userObj.address){
    alert("กรุณากรอกข้อมูลให้ครบทุกช่อง");
    return;
  }

  try {
    const res = await fetch(webAppUrl, {
      method: "POST",
      body: JSON.stringify(userObj),
      headers: { "Content-Type": "application/json" }
    });
    const result = await res.json();
    console.log("Register result:", result);

    if(result.error){
      alert("เกิดข้อผิดพลาดในการลงทะเบียน: " + result.error);
      return;
    }

    alert("ลงทะเบียนเรียบร้อย!");
    location.reload();

  } catch(err){
    console.error(err);
    alert("เกิดข้อผิดพลาดในการลงทะเบียน: " + err.message);
  }
}

main();
</script>
</body>
</html>
