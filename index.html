<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LIFF Registration</title>
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
<h1>ลงทะเบียนผู้ใช้</h1>
<div id="formContainer" style="display:none;">
  <p>ชื่อ: <input id="firstName"></p>
  <p>นามสกุล: <input id="lastName"></p>
  <p>เพศ: 
    <select id="gender">
      <option value="">เลือกเพศ</option>
      <option value="ชาย">ชาย</option>
      <option value="หญิง">หญิง</option>
    </select>
  </p>
  <p>เบอร์โทร: <input id="phone"></p>
  <p>ที่อยู่: <input id="address"></p>
  <button onclick="register()">ลงทะเบียน</button>
</div>
<div id="welcome" style="display:none;"></div>

<script>
const liffId = "2007981677-Z8m3omk4"; // LIFF ID ของคุณ
const webAppUrl = "https://script.google.com/macros/s/AKfycbzuot4dUqwY3nt1_XY6BYkcCbLU1_7WTm-awFK70vuSyM2ZsbROwGdbK6hDqvt8cbkB/exec";

let userProfile;

async function main() {
  await liff.init({ liffId });
  console.log("LIFF init done");
  
  if (!liff.isLoggedIn()) {
    console.log("User not logged in, redirecting...");
    liff.login();
    return;
  }

  try {
    userProfile = await liff.getProfile();
    console.log("User profile:", userProfile);

    const res = await fetch(webAppUrl, {
      method: "POST",
      body: JSON.stringify({ userId: userProfile.userId }),
      headers: { "Content-Type": "application/json" }
    });

    const result = await res.json();
    console.log("Check user result:", result);

    if (result.exists) {
      document.getElementById("welcome").style.display = "block";
      document.getElementById("welcome").innerText = `สวัสดี ${userProfile.displayName}! คุณลงทะเบียนแล้ว`;
      document.getElementById("formContainer").style.display = "none";
    } else {
      document.getElementById("formContainer").style.display = "block";
      document.getElementById("welcome").style.display = "none";
    }
    
  } catch(err) {
    console.error("Error fetching user data:", err);
    // แสดง form เผื่อมี error
    document.getElementById("formContainer").style.display = "block";
  }
}

async function register() {
  const userObj = {
    userId: userProfile.userId,
    displayName: userProfile.displayName,
    firstName: document.getElementById("firstName").value,
    lastName: document.getElementById("lastName").value,
    gender: document.getElementById("gender").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value
  };

  if (!userObj.firstName || !userObj.lastName || !userObj.gender || !userObj.phone || !userObj.address) {
    alert("กรุณากรอกข้อมูลให้ครบทุกช่อง");
    return;
  }

  try {
    const res = await fetch(webAppUrl, {
      method: "POST",
      body: JSON.stringify(userObj),
      headers: { "Content-Type": "application/json" }
    });
    const result = await res.json();
    console.log("Register result:", result);
    
    alert("ลงทะเบียนเรียบร้อย!");
    location.reload();

  } catch(err) {
    console.error("Error registering user:", err);
    alert("เกิดข้อผิดพลาดในการลงทะเบียน");
  }
}

main();
</script>
</body>
</html>
